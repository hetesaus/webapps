<html>
	<head>
		<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.12/css/uikit.min.css' />
	</head>
	<body>
		<div id="app">
			<div class="uk-grid-collapse" uk-grid>
				<div class="uk-width-1-4">
					<div class="uk-grid-collapse uk-child-width-1-1" uk-grid>
						<div class="uk-inline">
							<div id="player1" class="player"></div>
							<button class="overlayButton uk-width-1-1 uk-overlay uk-position-cover" @click="switchChannel(1)">
								<span class="channelName">{{ channels[1] }}</span>
							</button>
						</div>
						<div class="uk-inline">
							<div id="player2" class="player"></div>
							<button class="overlayButton uk-width-1-1 uk-overlay uk-position-cover" @click="switchChannel(2)">
								<span class="channelName">{{ channels[2] }}</span>
							</button>
						</div>
						<div class="uk-inline">
							<div id="player3" class="player"></div>        
							<button class="overlayButton uk-width-1-1 uk-overlay uk-position-cover" @click="switchChannel(3)">
								<span class="channelName">{{ channels[3] }}</span>
							</button>
						 </div>
					</div>
				</div>
				<div class="uk-width-3-4 uk-inline">
					<div id="player0" class="player"></div>
				</div>
				
				<div class="uk-grid-small uk-margin-small-top uk-width-1-1" uk-grid>
					<div class="uk-width-expand"></div>
					<div>
						<ul class="uk-iconnav">
							<li><a @click="openChat()" :uk-icon="'commenting'" uk-tooltip="Open chat"></a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>

<script src="https://player.twitch.tv/js/embed/v1.js"></script>
<script src="https://unpkg.com/vue"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.12/js/uikit.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.12/js/uikit-icons.min.js'></script>

<script>

	new Vue({
  		el: '#app',
  		data: {
			players: [],
			channels: [],
			volume: 1.0,
			padding: 4
  		},
		
		mounted() {
			this.getParameters();
			this.setPlayers();
			this.setChannels();
			
			window.addEventListener('resize', this.setPlayerSizes);
		},
		
		methods: {
			saveParameters() {
				localStorage.setItem('twitchChannels', this.channels);
				localStorage.setItem('twitchVolume', this.players[0].getVolume());
			},
		
			getParameters() {	
				var url = new URL(window.location.href);
				if (localStorage.getItem('twitchChannels') !== null) {
					this.channels = localStorage.getItem('twitchChannels').split(',');
					this.volume = localStorage.getItem('twitchVolume');
					return;
				}
				if (url.searchParams.get('channels')) {
					this.channels = url.searchParams.get('channels').split(' ');
					return;
				}
			},
			
			setPlayers() {
				for (var i = 0; i < 4; i ++) {
					var player =
						new Twitch.Player("player" + i,
						{
							width: this.getPlayerWidth(i) - this.padding,
							height: this.getPlayerHeight(i) - this.padding,
							layout: 'video',
							scrolling: 'no'
							channel: this.channels.length > 0 ? this.channels[i] : 'undefined',
						});
					
					player.setVolume(i > 0 ? 0 : volume);
					player.setQuality(i > 0 ? "360p30" : "auto");				
					this.players.push(player);
				}
			},		
			
			setChannels() {	
				for (var i = 0; i < this.channels.length; i ++) {
					this.players[i].setChannel(this.channels[i]);
					this.players[i].play();
				}
			},
			
			switchChannel(id) {
				if (this.channels[id] != undefined) {
					var old = this.channels[0];
					this.channels[0] = this.channels[id];
					this.channels[id] = old;
					
					this.players[0].setChannel(this.channels[0]);
					this.players[id].setChannel(this.channels[id]);
					
					console.log('switching from ' + this.channels[id] + ' to ' + this.channels[0]);
				}
				this.saveParameters();
			},
						
			openChat() {
				if (this.channels != null && this.channels.length > 0) {
					var url = 'https://www.twitch.tv/popout/' + this.channels[0] + '/chat?popout=';
					window.open(url, "", "width=400,height=700");
				}
			},
			
			setPlayerSizes() {
				for (var i = 0; i < 4; i++) {
					this.players[i].setWidth(this.getPlayerWidth(i) - this.padding);
					this.players[i].setHeight(this.getPlayerHeight(i) - this.padding);
				}
			},
			
			getPlayerWidth(index) {
				var windowWidth = this.getWindowWidth();
				var width = 
					index == 0
						? windowWidth - (windowWidth / 4)
						: windowWidth / 4;
				return width;
			},
			
			getPlayerHeight(index) {
				var width = this.getPlayerWidth(index);
				return width / 16 * 9;
			},
				
			getWindowWidth() {
				return window.innerWidth
				|| document.documentElement.clientWidth
				|| document.body.clientWidth;
			}
		}
	})	
	
</script>

<style>

	body {
		background-color: #0f0e11;
		overflow: hidden;
	}
	.player {
		padding: 2px;
		outline: 5px solid #000000;
		outline-offset: -5px;
	}
	.channelName {
		padding: 5px 10px;
		font-size: 18px;
		font-weight: bold;
		color: white;
		background-color: #b19dd8; 
		position: absolute;
		left: 0px;
		top: 0px;
	}
	.overlayButton {
		background: rgba(0, 0, 0, .0);
		opacity: 0.0;
	}
	.overlayButton:hover {
		background: rgba(0, 0, 0, .0);
		opacity: 1.0;
		outline: 5px solid #b19dd8;
		outline-offset: -5px;
	}
	
</style>
